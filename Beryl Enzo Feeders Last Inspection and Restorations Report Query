SELECT
  ef.EVENTNAME,
  ef.FEEDERNAME AS FEEDERNAME,
  ef.SUBSTATIONNAME AS SUBSTATIONNAME,
  ef.STARTDATETIME AS STARTDATETIME,
  RF.RESTOREDDATETIME AS SUBCASE_RESTORATION_TIME,
  ef.MAXRESTOREDDATETIME AS MAXRESTOREDDATETIME,
  ef.COMPLETEDDATETIME AS COMPLETEDDATETIME,
  ef.TROUBLE_LVL AS TROUBLE_LVL,
  ef.EVENTLOCATION AS EVENTLOCATION,
  ef.EVENTSTATUSKEY AS EVENTSTATUSKEY,
  ef.NUMCUSTRESTORED AS NUMCUSTRESTORED,
  ef.CAUSEKEY AS CAUSEKEY,
  ef.MOMENTARYOUTAGEFLAG AS MOMENTARYOUTAGEFLAG,
  ef.DURATIONHM AS DURATIONHM,
  ef.NUMCIRCUITS AS NUMCIRCUITS,
  ef.CIRCUITKEY AS CIRCUITKEY,
  ef.AFFECTEDFEEDERS AS AFFECTEDFEEDERS,
  ef.DEVICENAME AS DEVICENAME,
  ef.DEVICEOTGFLAG AS DEVICEOTGFLAG,
  ef.OUTAGEORG AS OUTAGEORG,
  ef.SERVICECENTER AS SERVICECENTER,
  ROW_NUMBER() OVER (PARTITION BY ef.eventname ORDER BY rf.restoreddatetime asc) AS SUBCASE,
  rf.totalcust
FROM OBVWH.OMS_EVENT_FACT@FPRP ef
INNER JOIN OBVWH.OMS_RESTORATION_FACT@FPRP rf ON rf.deeneventkey = ef.eventkey
INNER JOIN (SELECT DISTINCT RESTFACTKEY 
            FROM RRD.TB_CIRCUITOUTAGEHISTORY
            WHERE OUTDATETIME BETWEEN TO_DATE('01/20/2025 00:00:00', 'MM/DD/YYYY HH24:MI:SS') 
                                 AND TO_DATE('01/22/2025 23:59:59', 'MM/DD/YYYY HH24:MI:SS')
            AND TROUBLE_LVL = 'C') ch ON ch.RESTFACTKEY = RF.RESTFACTKEY
WHERE ef.EXCLUDETROUBLEFLAG = 0
  AND ef.MOMENTARYOUTAGEFLAG = 0
  AND ef.CANCELLEDFLAG = 0
  AND ef.PLANNEDOTGFLAG = 0
  AND ef.NONOUTGCALLFLAG = 0
  AND ef.ORPHANOUTAGEFLAG = 0
  AND ef.SERVICECENTER NOT IN ('BV', 'EV', 'FB', 'MV', 'RP', 'INDIANA')
  AND ef.FEEDERNAME != '-Missing Feeder-'
  AND ef.trouble_lvl = 'C'
ORDER BY EF.EVENTNAME, SUBCASE ASC;

